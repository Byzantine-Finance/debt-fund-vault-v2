# Vault v2

## Overview

Morpho Vault V2 is a protocol for noncustodial risk management.
It enables anyone to create a vault depositing liquidity into both Morpho Market V2 and [Morpho Market V1](https://github.com/morpho-org/morpho-blue).

Users of Morpho Vault V2 are liquidity providers who want to earn from borrowing interest without having to actively manage the risk of their position.
The active management of the deposited assets is the responsibility of a set of different roles.
These roles are primarily responsible for enabling and disabling markets on Morpho Market V1 and Morpho Market V2 as well as managing the allocation of users’ funds across those markets.

[Morpho Vault V2](https://github.com/morpho-org/vaults-v2/blob/main/src/VaultV2.sol) vaults are [**ERC-4626](https://eips.ethereum.org/EIPS/eip-4626)** vaults, with ([ERC-2612](https://eips.ethereum.org/EIPS/eip-2612)) permit.
One Morpho Vault V2 is related to one loan asset.
The [VaultV2Factory](https://github.com/morpho-org/vaults-v2/blob/main/src/VaultV2Factory.sol) is deploying immutable onchain instances of Vaults V2.

TODO: mention liquidity markets
Users can supply or withdraw assets at any time, depending on the available liquidity on the underlying markets.
Each market has a supply cap and a relative cap that guarantees lenders both a maximum absolute and a maximum relative exposure to the specific market.

There are 5 different roles for a MetaMorpho vault: owner, curator, sentinel, treasurer and allocator.

In Vault V2, all actions are potentially subject to a timelock.
Owners are encouraged to subect actions that may be against users' interests (e.g. enabling a market with a high exposure) to a timelock.
Timelocks change must set the value between 0 and 2 weeks.

The `sentinel`, if set, can revoke the actions taken by other roles during the timelock, with the exception of the action setting the sentinel.
After the timelock, the action can be executed by anyone.

### Roles

**Owner**

Only one address can have this role.

It can:

- Set other roles:
    - `sentinel`
    - `owner`
    - `curator`
    - `treasurer`
    - `allocator`
- Set the `performanceFeeRecipient`.
- Set the `managementFeeRecipient`.
- Set the `irm`. The `irm` is responsible for returning the per second interests accrued by users. This is in contrast with Vault V1 where the interest was automatically computed based on the underlying allocations.
- [Timelocked] Increase the timelock.
- [Timelocked] Decrease the timelock.

**Treasurer**

Only one address can have this role.

It can:

- Set the `performanceFee`. The performance fee is capped at 50% of generated interest.
- Set the `managementFee`. The management fee is capped at 5% of generated interest.

**Allocator**

Multiple addresses can have this role.

It can:

- Reallocate funds from the “idle market” to enabled markets.
- Reallocate funds from enabled markets to the “idle market”.

**Curator**

Only one address can have this role.

It can:

- [Timelocked] Decrease the absolute supply cap of any market.
- [Timelocked] Decrease the relative supply cap of any market.
- [Timelocked] Increase the absolute supply cap of any market.
- [Timelocked] Increase the relative supply cap of any market.

**Sentinel**

Multiple addresses can have this role.

It can:

- Reallocate funds from the “idle market” to enabled markets.
- Reallocate funds from enabled markets to the “idle market”.
- [Timelocked] Decrease the absolute supply cap of any market.
- Revoke actions from other roles, except the `setSentinel` action (contrary to Vault V1, the sentinel cannot revoke any attempt to change the sentinel).

### Main differences with Vault V1

- The curator is responsible for setting the interest of the vault. This implies monitoring interests generated by the vault in order to set an interest that is in line with the profits generated by the vault.
- The `Guardian` role of Vault V1 has been replaced by a `Sentinel` role. The scope of the
- The `Treasurer` role has been introduced. This role can set the performance and management fees. Separating the treasurer role from the cura
- Contrary to Vault V1, the `Owner` does not inherit the other roles.
- All actions are timelockable, except `reallocateIn` and `reallocateOut` and timelocks are not constrained anymore.

## Getting started

### Package installation

Install [Foundry](https://book.getfoundry.sh/getting-started/installation).

### Run tests

Run `forge test`.

## Audits

All audits are stored in the [`audits`](./audits) folder.

## License

Files in this repository are publicly available under license `GPL-2.0-or-later`, see [`LICENSE`](./LICENSE).
